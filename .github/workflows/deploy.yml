name: "Build and Deploy to GKE"

on:
  push:
    branches:
      - main

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_GAR_LOCATION: ${{ secrets.GCP_GAR_LOCATION }}
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
  GCP_FRONTEND_REPO: ${{ secrets.GCP_FRONTEND_REPO }}
  GCP_BACKEND_REPO: ${{ secrets.GCP_BACKEND_REPO }}
  GCP_FRONTEND_IMAGE: ${{ secrets.GCP_FRONTEND_IMAGE }}
  GCP_BACKEND_IMAGE: ${{ secrets.GCP_BACKEND_IMAGE }}
  GCP_GKE_CLUSTER: ${{ secrets.GCP_GKE_CLUSTER }}
  GCP_GKE_REGION: ${{ secrets.GCP_GKE_REGION }}

jobs:
  build-deploy:
    name: "Build and Deploy"
    runs-on: "ubuntu-latest"
    timeout-minutes: 30

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"

      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: "Configure Docker"
        run: |
          gcloud auth configure-docker ${{ env.GCP_GAR_LOCATION }}-docker.pkg.dev

      - name: "Build And Push Frontend Image"
        run: |
          IMAGE_NAME=${{ env.GCP_GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_FRONTEND_REPO }}/${{ env.GCP_FRONTEND_IMAGE }}:latest
          docker build -t ${IMAGE_NAME} ./client
          docker push ${IMAGE_NAME}

      - name: "Build And Push Backend Image"
        run: |
          IMAGE_NAME=${{ env.GCP_GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_BACKEND_REPO }}/${{ env.GCP_BACKEND_IMAGE }}:latest
          docker build -t ${IMAGE_NAME} ./server
          docker push ${IMAGE_NAME}

      - name: "Set up GKE credentials"
        uses: "google-github-actions/get-gke-credentials@v2"
        with:
          cluster_name: ${{ env.GCP_GKE_CLUSTER }}
          location: ${{ env.GCP_GKE_REGION }}

      - name: "Create namespace"
        run: |
          kubectl apply -f k8s/namespace.yaml

      - name: "Apply ConfigMaps and Secrets"
        run: |
          kubectl apply -f k8s/server-config.yaml
          kubectl apply -f k8s/server-secret.yaml

      - name: "Apply Deployments"
        run: |
          kubectl apply -f k8s/client-deployment.yaml
          kubectl apply -f k8s/server-deployment.yaml

      - name: "Apply Services"
        run: |
          kubectl apply -f k8s/client-service.yaml
          kubectl apply -f k8s/server-service.yaml

      - name: "Apply Ingress"
        run: |
          kubectl apply -f k8s/ingress.yaml

      - name: "Summary"
        run: |
          echo "--------------------------------------------------------------------------------------"
          echo "Frontend Image: ${{ env.GCP_GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_FRONTEND_REPO }}/${{ env.GCP_FRONTEND_IMAGE }}:latest"
          echo "Backend Image: ${{ env.GCP_GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_BACKEND_REPO }}/${{ env.GCP_BACKEND_IMAGE }}:latest"
          echo "--------------------------------------------------------------------------------------"
          echo "ðŸŽ‰Deployment completed successfully!"
