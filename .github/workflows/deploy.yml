name: "Build and Deploy to GKE"

on:
    push:
        branches:
            - main

env:
    PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    GCP_LOCATION: ${{ secrets.GCP_GAR_LOCATION }}
    GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
    GCP_FRONTEND_REPO: ${{ secrets.GCP_REPOSITORY }}
    GCP_BACKEND_REPO: ${{ secrets.GCP_REPOSITORY }}
    GCP_FRONTEND_IMAGE: ${{ secrets.GCP_FRONTEND_IMAGE }}
    GCP_BACKEND_IMAGE: ${{ secrets.GCP_BACKEND_IMAGE }}

jobs:
    build-deploy:
        name: "Build and Deploy"
        runs-on: "ubuntu-latest"
        timeout-minutes: 30

        steps:
            - name: "Checkout"
              uses: "actions/checkout@v4"

            - name: "Authenticate to Google Cloud"
              uses: "google-github-actions/auth@v2"
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}
                  project_id: ${{ env.PROJECT_ID }}

            - name: "Set up Cloud SDK"
              uses: "google-github-actions/setup-gcloud@v2"

            - name: "Configure Docker"
              run: |
                  gcloud auth configure-docker ${{ env.GCP_LOCATION }}-docker.pkg.dev

            - name: "Build And Push Frontend Image"
              run: |
                  IMAGE_NAME=${{ env.GCP_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GCP_FRONTEND_REPO }}/${{ env.GCP_FRONTEND_IMAGE }}:latest
                  docker build -t ${IMAGE_NAME} ./frontend
                  docker push ${IMAGE_NAME}

            - name: "Build And Push Backend Image"
              run: |
                  IMAGE_NAME=${{ env.GCP_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GCP_BACKEND_REPO }}/${{ env.GCP_BACKEND_IMAGE }}:latest
                  docker build -t ${IMAGE_NAME} ./backend
                  docker push ${IMAGE_NAME}

            - name: "Summary"
              run: |
                  echo "--------------------------------------------------------------------------------------"
                  echo "Frontend Image: ${GCP_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GCP_FRONTEND_REPO}/${GCP_FRONTEND_IMAGE}:latest"
                  echo "Backend Image: ${GCP_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GCP_BACKEND_REPO}/${GCP_BACKEND_IMAGE}:latest"
                  echo "--------------------------------------------------------------------------------------"
                  echo "ðŸŽ‰Deployment completed successfully!"
